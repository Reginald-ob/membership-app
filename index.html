<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>會員積分管理系統</title>
    <!-- Tailwind CSS (忽略 Production 警告) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase JS Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        .user-grid { display: grid; grid-template-rows: 1fr 2fr; height: 100vh; }
        .hidden { display: none !important; }
        input, select, textarea { font-size: 16px; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 h-screen overflow-hidden">

    <!-- Config Overlay -->
    <div id="config-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-95 z-[100] flex items-center justify-center">
        <div class="bg-white p-8 rounded shadow-lg max-w-md text-center">
            <h2 class="text-xl font-bold mb-4 text-red-600">系統尚未設定</h2>
            <p class="mb-4 text-sm text-gray-600">請編輯 HTML 檔案，填入 Supabase URL 與 Key。</p>
        </div>
    </div>

    <!-- 1. Auth View -->
    <div id="auth-view" class="h-full flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm relative">
            <h1 id="auth-title" class="text-2xl font-bold text-center mb-6 text-gray-800">會員登入</h1>
            <div id="auth-message" class="mb-4 text-sm text-center hidden p-2 rounded"></div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase">電子信箱</label>
                    <input type="email" id="email" class="mt-1 block w-full rounded border-gray-300 bg-gray-50 border px-3 py-2 outline-none focus:ring-2 focus:ring-indigo-500">
                </div>

                <div id="password-group">
                    <label class="block text-xs font-bold text-gray-500 uppercase">密碼</label>
                    <input type="password" id="password" class="mt-1 block w-full rounded border-gray-300 bg-gray-50 border px-3 py-2 outline-none focus:ring-2 focus:ring-indigo-500">
                </div>

                <div id="register-fields" class="hidden space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase">真實姓名</label>
                        <input type="text" id="full_name" class="mt-1 block w-full rounded border-gray-300 bg-gray-50 border px-3 py-2 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase">電話號碼</label>
                        <input type="tel" id="phone" class="mt-1 block w-full rounded border-gray-300 bg-gray-50 border px-3 py-2 outline-none">
                    </div>
                </div>

                <div id="forgot-fields" class="hidden space-y-4">
                    <div class="bg-yellow-50 p-3 rounded text-xs text-yellow-800 mb-2 border border-yellow-200">
                        請輸入助記詞以重設密碼。
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase">助記詞</label>
                        <input type="text" id="recovery-mnemonic" placeholder="apple-banana-..." class="mt-1 block w-full rounded border-gray-300 bg-gray-50 border px-3 py-2 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase">新密碼</label>
                        <input type="password" id="new-password" class="mt-1 block w-full rounded border-gray-300 bg-gray-50 border px-3 py-2 outline-none">
                    </div>
                </div>

                <button id="btn-submit" class="w-full py-3 px-4 rounded shadow-sm text-sm font-bold text-white bg-indigo-600 hover:bg-indigo-700 transition">登入</button>

                <div class="flex justify-between text-xs mt-4 text-gray-500">
                    <a href="#" id="link-forgot" class="hover:text-indigo-600">忘記密碼？</a>
                    <a href="#" id="link-toggle-mode" class="hover:text-indigo-600 ml-auto">註冊新會員</a>
                </div>
                <div id="link-back-login-container" class="hidden text-center mt-4">
                    <a href="#" id="link-back-login" class="text-xs text-indigo-600 font-bold">返回登入</a>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. Mnemonic Modal -->
    <div id="mnemonic-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-80 hidden">
        <div class="bg-white p-6 rounded-lg shadow-2xl max-w-md w-full mx-4 text-center">
            <div class="text-5xl text-yellow-500 mb-4 flex justify-center"><i class="ph ph-shield-warning"></i></div>
            <h2 class="text-xl font-bold text-red-600 mb-2">請抄寫助記詞</h2>
            <p class="text-sm text-gray-600 mb-4 text-left">這是找回帳號的唯一方式，請務必記錄。</p>
            <div class="bg-gray-100 p-4 rounded border-2 border-dashed border-gray-400 mb-6">
                <code id="generated-mnemonic" class="text-lg font-mono font-bold text-indigo-700 break-all select-all"></code>
            </div>
            <button onclick="closeMnemonicModal()" class="w-full py-2 bg-red-600 text-white rounded hover:bg-red-700 font-bold">我已抄寫</button>
        </div>
    </div>

    <!-- 3. User View -->
    <div id="user-view" class="user-grid hidden bg-white">
        <div class="bg-gradient-to-br from-indigo-600 to-indigo-800 flex flex-col items-center justify-center text-white relative">
            <button onclick="handleLogout()" class="absolute top-4 right-4 text-xs bg-black bg-opacity-20 px-3 py-1 rounded hover:bg-opacity-40">登出</button>
            <h2 class="text-sm uppercase tracking-widest opacity-70 mb-1">Total Points</h2>
            <div class="text-7xl font-bold font-mono tracking-tighter" id="user-points-display">0</div>
        </div>
        <div class="bg-gray-50 p-8 flex flex-col">
            <div class="max-w-md mx-auto w-full space-y-6">
                <h3 class="text-lg font-bold text-gray-800 border-b pb-2">會員資訊</h3>
                <div class="grid grid-cols-3 gap-y-4 text-sm">
                    <div class="text-gray-500">編號</div> <div id="user-id-display" class="font-bold text-gray-900 col-span-2 font-mono">...</div>
                    <div class="text-gray-500">姓名</div> <div id="user-name-display" class="font-bold text-gray-900 col-span-2">...</div>
                    <div class="text-gray-500">帳號</div> <div id="user-email-display" class="font-bold text-gray-900 col-span-2 break-all">...</div>
                    <div class="text-gray-500">電話</div> <div id="user-phone-display" class="font-bold text-gray-900 col-span-2">...</div>
                    <div class="text-gray-500">助記詞</div> <div class="font-bold text-gray-900 col-span-2 tracking-widest">*****</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 4. Admin View -->
    <div id="admin-view" class="h-full flex flex-col hidden bg-gray-100">
        <div class="bg-white shadow px-6 py-4 flex justify-between items-center z-10">
            <h1 class="text-lg font-bold text-gray-800 flex items-center gap-2"><i class="ph ph-storefront text-indigo-600"></i> 店家管理系統</h1>
            <button onclick="handleLogout()" class="text-sm text-gray-500 hover:text-red-600 font-medium">登出</button>
        </div>
        <div class="p-4 bg-gray-50 border-b flex gap-2">
            <input type="text" id="admin-search" placeholder="搜尋姓名或電話..." class="flex-1 rounded border border-gray-300 px-4 py-2 text-sm outline-none">
            <button onclick="fetchUsers()" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700"><i class="ph ph-arrows-clockwise"></i></button>
        </div>
        <div class="flex-1 overflow-auto p-4">
            <div class="bg-white rounded shadow overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50"><tr><th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase">用戶</th><th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase">點數</th><th class="px-4 py-3 text-right text-xs font-bold text-gray-500 uppercase">操作</th></tr></thead>
                    <tbody id="user-table-body" class="bg-white divide-y divide-gray-200 text-sm"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 5. Admin Modal -->
    <div id="admin-modal" class="fixed inset-0 z-40 flex items-center justify-center bg-black bg-opacity-75 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg overflow-hidden mx-4">
            <div class="px-6 py-4 bg-gray-50 border-b flex justify-between items-center">
                <h3 class="text-lg font-bold text-gray-800">會員管理</h3>
                <button onclick="closeAdminModal()" class="text-gray-400 hover:text-gray-600"><i class="ph ph-x text-xl"></i></button>
            </div>
            <div class="p-6 space-y-6">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-xs font-bold text-gray-500">編號</label><input id="edit-display-id" disabled class="w-full bg-gray-100 border-b border-transparent text-sm py-1 font-mono"></div>
                    <div><label class="block text-xs font-bold text-gray-500">目前點數</label><div id="edit-current-points" class="text-2xl font-bold text-indigo-600">0</div></div>
                    <div class="col-span-2"><label class="block text-xs font-bold text-gray-500">姓名</label><input id="edit-name" class="w-full border-b border-gray-300 py-1 outline-none"></div>
                    <div class="col-span-2"><label class="block text-xs font-bold text-gray-500">電話</label><input id="edit-phone" class="w-full border-b border-gray-300 py-1 outline-none"></div>
                </div>

                <!-- Transaction Area -->
                <div class="bg-indigo-50 p-4 rounded border border-indigo-100">
                    <h4 class="text-sm font-bold text-indigo-800 mb-3 flex items-center gap-2"><i class="ph ph-coins"></i> 新增交易</h4>
                    <div class="flex gap-2 mb-2">
                        <select id="trans-type" class="text-sm border border-gray-300 rounded px-2 py-1 outline-none bg-white">
                            <option value="add">增加 (+)</option>
                            <option value="deduct">扣除 (-)</option>
                        </select>
                        <input type="number" id="trans-amount" placeholder="數量" class="flex-1 text-sm border border-gray-300 rounded px-2 py-1 outline-none" min="1">
                    </div>
                    <input type="text" id="trans-reason" placeholder="交易備註" class="w-full text-sm border border-gray-300 rounded px-2 py-1 mb-3 outline-none">
                    <button onclick="confirmTransaction()" id="btn-trans" class="w-full bg-indigo-600 text-white text-sm py-2 rounded hover:bg-indigo-700 font-bold shadow-sm">確認交易</button>
                </div>
            </div>
            <div class="px-6 py-3 bg-gray-50 flex justify-end gap-3">
                <button onclick="closeAdminModal()" class="px-4 py-2 border rounded text-gray-600 hover:bg-gray-100 text-sm">關閉</button>
                <button onclick="saveProfileChanges()" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 text-sm font-bold">儲存資料修改</button>
            </div>
        </div>
    </div>

    <input type="hidden" id="hidden-uid">

    <script>
        // ==========================================
        // CONFIG
        // ==========================================
        const SUPABASE_URL = 'https://xnubbczorjzwlpbkjrfo.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhudWJiY3pvcmp6d2xwYmtqcmZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ5Mjg3MDEsImV4cCI6MjA4MDUwNDcwMX0.pqkraWF9WWHrKxInUHa3CaUWNt1twMZXkFyvxPIyVvs';
        // ==========================================

        let sbClient; // [修正] 重新命名變數，避免與 window.supabase 衝突
        let currentUser = null;
        let adminUsersCache = [];
        let authMode = 'login';

        // 初始化檢查
        if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
            document.getElementById('config-overlay').classList.remove('hidden');
        } else {
            document.getElementById('config-overlay').classList.add('hidden');
            // [修正] 使用 window.supabase 確保取得正確的函式庫物件
            sbClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            initApp();
        }

        function initApp() {
            // [修正] 使用 sbClient 而非 supabase
            sbClient.auth.onAuthStateChange((event, session) => {
                if (session) {
                    currentUser = session.user;
                    loadProfile(currentUser.id);
                } else {
                    currentUser = null;
                    switchView('auth');
                }
            });
            setupEventListeners();
        }

        function switchView(name) {
            document.querySelectorAll('body > div[id$="-view"]').forEach(el => el.classList.add('hidden'));
            document.getElementById(name + '-view').classList.remove('hidden');
        }

        function setAuthMode(mode) {
            authMode = mode;
            document.getElementById('auth-message').classList.add('hidden');
            const map = {
                login: { title: '會員登入', btn: '登入', show: ['password-group'], hide: ['register-fields', 'forgot-fields', 'link-back-login-container'] },
                register: { title: '註冊新會員', btn: '確認註冊', show: ['register-fields', 'password-group', 'link-back-login-container'], hide: ['forgot-fields', 'link-toggle-mode', 'link-forgot'] },
                forgot: { title: '重設密碼', btn: '重設並登入', show: ['forgot-fields', 'link-back-login-container'], hide: ['password-group', 'register-fields', 'link-toggle-mode', 'link-forgot'] }
            };
            
            document.getElementById('link-toggle-mode').classList.remove('hidden');
            document.getElementById('link-forgot').classList.remove('hidden');
            
            const cfg = map[mode];
            document.getElementById('auth-title').innerText = cfg.title;
            document.getElementById('btn-submit').innerText = cfg.btn;
            
            ['register-fields', 'forgot-fields', 'password-group', 'link-back-login-container'].forEach(id => document.getElementById(id).classList.add('hidden'));
            cfg.show.forEach(id => document.getElementById(id).classList.remove('hidden'));
            if(cfg.hide) cfg.hide.forEach(id => document.getElementById(id).classList.add('hidden'));
        }

        function setupEventListeners() {
            document.getElementById('link-toggle-mode').onclick = () => setAuthMode('register');
            document.getElementById('link-forgot').onclick = () => setAuthMode('forgot');
            document.getElementById('link-back-login').onclick = () => setAuthMode('login');

            document.getElementById('btn-submit').onclick = async () => {
                const email = document.getElementById('email').value;
                const pwd = document.getElementById('password').value;
                const btn = document.getElementById('btn-submit');
                
                if(!email) return showMsg('請輸入 Email', true);
                btn.disabled = true; btn.innerText = '處理中...';

                try {
                    if (authMode === 'login') {
                        // [修正] 使用 sbClient
                        const { error } = await sbClient.auth.signInWithPassword({ email, password: pwd });
                        if(error) throw error;
                    } else if (authMode === 'register') {
                        await handleRegister(email, pwd);
                    } else if (authMode === 'forgot') {
                        await handleResetPassword(email);
                    }
                } catch (err) {
                    showMsg(err.message, true);
                } finally {
                    btn.disabled = false; btn.innerText = authMode === 'login' ? '登入' : '送出';
                }
            };
        }
        
        // 新增：專門負責產生 BIP-0039 助記詞的函式
        async function generateBIP39Mnemonic() {
            try {
                // 1. 從 CDN 讀取標準單詞庫 (解決 CORS 與 明碼問題)
                const response = await fetch('https://cdn.jsdelivr.net/gh/bitcoin/bips/bip-0039/english.txt');
                if (!response.ok) throw new Error('無法讀取單詞庫');
                
                const text = await response.text();
                // 將文字檔轉為陣列，去除空白行
                const wordList = text.split('\n').map(w => w.trim()).filter(w => w.length > 0);

                if (wordList.length < 2048) throw new Error('單詞庫讀取不完整');

                // 2. 產生 12 個隨機單詞 (使用加密級亂數)
                const selectedWords = [];
                const array = new Uint32Array(12); // 準備 12 個位置
                window.crypto.getRandomValues(array); // 填入加密級亂數

                for (let i = 0; i < 12; i++) {
                    // 取餘數確保數值落在 0 ~ 2047 之間
                    const index = array[i] % wordList.length;
                    selectedWords.push(wordList[index]);
                }

                // 3. 加上原本的隨機數字後綴 (維持您原本的設計風格，或可移除)
                // 這裡保留後綴是為了避免純單詞被誤認為標準錢包助記詞，增加一點客製化識別
                const randomSuffix = Math.floor(1000 + Math.random() * 9000);
                
                return selectedWords.join('-') + '-' + randomSuffix;

            } catch (err) {
                console.error('助記詞產生失敗:', err);
                // 萬一網路斷線的備案：回退到簡單版，避免無法註冊
                return 'backup-code-' + Date.now().toString(36); 
            }
        }

        // 修改原本的 handleRegister 函式
        async function handleRegister(email, password) {
            const name = document.getElementById('full_name').value;
            const phone = document.getElementById('phone').value;
            if(!name || !phone) throw new Error('請填寫完整資料');

            // [修正點]：呼叫上方的新函式，使用 await 等待結果
            const mnemonic = await generateBIP39Mnemonic();
            
            // 下方維持原本的 Supabase 註冊邏輯不變 ...
            const { data, error } = await sbClient.auth.signUp({ 
                email, 
                password,
                options: {
                    data: {
                        full_name: name,
                        phone: phone,
                        mnemonic: mnemonic
                    }
                }
            });
            
            if(error) throw error;
            
            // 顯示助記詞
            document.getElementById('generated-mnemonic').innerText = mnemonic;
            document.getElementById('mnemonic-modal').classList.remove('hidden');
        }

    async function handleResetPassword(email) {
                // 1. 強制去除前後空白
                const safeEmail = email.trim(); 
                const mnemonic = document.getElementById('recovery-mnemonic').value.trim();
                const newPwd = document.getElementById('new-password').value;
                
                if(!mnemonic || !newPwd) throw new Error('請填寫助記詞與新密碼');

                console.log("正在嘗試重設...");
                console.log("Email:", safeEmail);
                console.log("Mnemonic:", mnemonic);

                // 呼叫 RPC
                const { data, error } = await sbClient.rpc('reset_password_via_mnemonic', {
                    target_email: safeEmail, 
                    mnemonic_check: mnemonic, 
                    new_password: newPwd
                });

                // 詳細錯誤處理
                if (error) {
                    console.error("RPC Error:", error);
                    throw new Error('系統錯誤: ' + error.message);
                }
                
                // data 為 false 代表 SQL 內的 if 判斷沒過
                if (data === false) {
                    console.error("RPC 回傳 False。原因可能是：Email 沒對上，或是助記詞沒對上。");
                    throw new Error('重設失敗：助記詞錯誤或帳號不存在 (請檢查資料庫 profiles 表格是否有值)');
                }
                
                showMsg('密碼已重設，請登入', false);
                setTimeout(() => setAuthMode('login'), 1500);
            }
        async function loadProfile(uid) {
            const { data, error } = await sbClient.from('profiles').select('*').eq('id', uid).single();
            if(error) { sbClient.auth.signOut(); return; }
            if(data.role === 'admin') { switchView('admin'); fetchUsers(); }
            else { renderUserView(data); switchView('user'); }
        }

        function renderUserView(p) {
            document.getElementById('user-points-display').innerText = p.points;
            document.getElementById('user-id-display').innerText = p.user_id_display;
            document.getElementById('user-name-display').innerText = p.full_name;
            document.getElementById('user-email-display').innerText = currentUser.email;
            document.getElementById('user-phone-display').innerText = p.phone;
        }

        async function handleLogout() { await sbClient.auth.signOut(); }

        // --- 店家功能 ---
        async function fetchUsers() {
            const { data } = await sbClient.from('profiles').select('*').order('created_at', {ascending: false});
            adminUsersCache = data || [];
            const tbody = document.getElementById('user-table-body');
            tbody.innerHTML = '';
            adminUsersCache.forEach(u => {
                if(u.role === 'admin') return;
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50 border-b';
                tr.innerHTML = `<td class="px-4 py-3"><div>${u.full_name}</div><div class="text-xs text-gray-500">${u.phone}</div></td><td class="px-4 py-3 font-bold text-indigo-600">${u.points}</td><td class="px-4 py-3 text-right"><button onclick="openAdminModal('${u.id}')" class="text-indigo-600 border border-indigo-600 px-3 py-1 rounded text-xs hover:bg-indigo-50">管理</button></td>`;
                tbody.appendChild(tr);
            });
        }

        document.getElementById('admin-search').addEventListener('input', (e) => {
            const val = e.target.value.toLowerCase();
            document.querySelectorAll('#user-table-body tr').forEach(r => r.style.display = r.innerText.toLowerCase().includes(val) ? '' : 'none');
        });

        function openAdminModal(uid) {
            const user = adminUsersCache.find(u => u.id === uid);
            document.getElementById('hidden-uid').value = uid;
            document.getElementById('edit-display-id').value = user.user_id_display;
            document.getElementById('edit-current-points').innerText = user.points;
            document.getElementById('edit-name').value = user.full_name;
            document.getElementById('edit-phone').value = user.phone;
            document.getElementById('trans-amount').value = '';
            document.getElementById('trans-reason').value = '';
            document.getElementById('admin-modal').classList.remove('hidden');
        }
        function closeAdminModal() { document.getElementById('admin-modal').classList.add('hidden'); }

        async function confirmTransaction() {
            const uid = document.getElementById('hidden-uid').value;
            const type = document.getElementById('trans-type').value;
            const amount = parseInt(document.getElementById('trans-amount').value);
            const reason = document.getElementById('trans-reason').value;

            if(!amount || amount <= 0) return alert('請輸入有效數量');
            if(!reason) return alert('請輸入交易備註');

            const changeAmount = type === 'add' ? amount : -amount;
            const btn = document.getElementById('btn-trans');
            btn.disabled = true; btn.innerText = '處理中...';

            try {
                // [修正] 使用 sbClient
                const { error } = await sbClient.from('point_logs').insert([{
                    user_id: uid,
                    admin_id: currentUser.id,
                    change_amount: changeAmount,
                    reason: reason
                }]);

                if(error) throw error;

                alert('交易成功');
                closeAdminModal();
                fetchUsers(); 
            } catch(err) {
                if (err.message && err.message.includes('profiles_points_check')) {
                    alert('交易失敗：用戶點數餘額不足，無法扣除。');
                } else {
                    alert('交易失敗：' + err.message);
                }
            } finally {
                btn.disabled = false; btn.innerText = '確認交易';
            }
        }

        async function saveProfileChanges() {
            const uid = document.getElementById('hidden-uid').value;
            const { error } = await sbClient.from('profiles').update({
                full_name: document.getElementById('edit-name').value,
                phone: document.getElementById('edit-phone').value
            }).eq('id', uid);
            if(error) alert('失敗'); else { alert('已儲存'); closeAdminModal(); fetchUsers(); }
        }

        function showMsg(text, isError) {
            const el = document.getElementById('auth-message');
            el.innerText = text;
            el.className = `mb-4 text-sm text-center p-2 rounded ${isError ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
            el.classList.remove('hidden');
        }
    </script>
</body>
</html>